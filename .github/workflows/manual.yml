name: Deploy to AWS EC2
on:
  push:
    branches:
      - main  # Adjust branch if needed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Connect to EC2 and Run Command
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.USERNAME }}@${{ secrets.EC2_PUBLIC_IP }} "echo 'âœ… SSH Connection Successful!'"
      
      # Step 4: SSH into EC2 and Deploy in a Screen Session
      - name: Deploy to EC2
        run: |
          echo "ğŸš€ Starting Deployment..."

          # Ensure Docker is installed
          if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              sudo apt update && sudo apt install -y docker.io
          fi

          # Check if the screen session exists before trying to kill it
          if screen -ls | grep -q "production"; then
              echo "ğŸ–¥ï¸ Stopping existing screen session..."
              screen -S production -X quit
          fi
          
          # Start a new screen session for deployment
          echo "ğŸ–¥ï¸ Starting a new screen session for deployment..."
          screen -dmS production bash -c '
          
          echo "ğŸ“¦ Pulling latest changes..."
          echo "Pwd command"
          pwd
          echo "after Pwd"
          cd /home/ubuntu/stock-viz-docker || { echo "âŒ Directory not found"; exit 1; }
          git fetch --all
          git reset --hard origin/main || { echo "âŒ Git pull failed"; exit 1; }
          git submodule update --recursive --remote || { echo "âŒ Submodule update failed"; exit 1; }

          echo "ğŸ›‘ Stopping existing containers and cleaning up resources..."
          docker-compose down --volumes --rmi all --remove-orphans || true

          echo "ğŸ”¨ Building and running Next.js app and other services..."
          docker-compose up -d --build || { echo "âŒ Deployment failed"; exit 1; }

          echo "âœ… Deployment Successful!"
          docker-compose ps
          '

          echo "âœ… Deployment is running in screen session: production"
