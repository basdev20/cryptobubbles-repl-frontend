name: Deploy to AWS EC2
on:
  push:
    branches:
      - main  # Adjust branch if needed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Connect to EC2 and Run Command
        run: ssh -o StrictHostKeyChecking=no -i private_key.pem ${{secrets.USERNAME}}@${{ secrets.EC2_PUBLIC_IP }} "echo '✅ SSH Connection Successful!'"
      
      # Step 4: SSH into EC2 and Deploy in a Screen Session
      - name: Deploy to EC2
        run: |


          echo "🚀 Starting Deployment..."

          # Ensure Docker is installed
          if ! command -v docker &> /dev/null; then
              echo "🐳 Installing Docker..."
              sudo apt update && sudo apt install -y docker.io
          fi

          # Kill existing screen session if it exists
          if screen -ls | grep -q ""; then
              echo "🖥️  Stopping existing screen session..."
              screen -S regXperienceScreen -X quit
          fi

          # Start a new screen session for deployment
          screen -dmS regXperienceScreen bash -c '
          
          echo "📦 Pulling latest changes..."
          cd ~/regXperience || { echo "❌ Directory not found"; exit 1; }
          git fetch --all
          git reset --hard origin/main || { echo "❌ Git pull failed"; exit 1; }

          echo "🛑 Stopping existing container..."
          docker stop nextjs-container || true
          docker rm nextjs-container || true

          echo "🔨 Building and running Next.js app..."
          docker build -t nextjs-app .
          docker run -d -p 3000:3000 --name nextjs-container --restart always nextjs-app

          echo "✅ Deployment Successful!"
          docker ps
          '

          echo "✅ Deployment is running in screen session: regXperienceScreen"

          EOF
