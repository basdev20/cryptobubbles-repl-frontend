name: Deploy to AWS EC2
on:
  push:
    branches:
      - main  # Adjust branch if needed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 3: Test SSH Connection
      - name: Test SSH Connection
        run: |
          ssh -o StrictHostKeyChecking=no admin@${{ secrets.EC2_PUBLIC_IP }} "echo 'âœ… SSH Connection Successful!'"

      # Step 4: SSH into EC2 and Deploy in a Screen Session
      - name: Deploy to EC2
        run: |


          echo "ğŸš€ Starting Deployment..."

          # Ensure Docker is installed
          if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              sudo apt update && sudo apt install -y docker.io
          fi

          # Kill existing screen session if it exists
          if screen -ls | grep -q ""; then
              echo "ğŸ–¥ï¸  Stopping existing screen session..."
              screen -S regXperienceScreen -X quit
          fi

          # Start a new screen session for deployment
          screen -dmS regXperienceScreen bash -c '
          
          echo "ğŸ“¦ Pulling latest changes..."
          cd ~/regXperience || { echo "âŒ Directory not found"; exit 1; }
          git fetch --all
          git reset --hard origin/main || { echo "âŒ Git pull failed"; exit 1; }

          echo "ğŸ›‘ Stopping existing container..."
          docker stop nextjs-container || true
          docker rm nextjs-container || true

          echo "ğŸ”¨ Building and running Next.js app..."
          docker build -t nextjs-app .
          docker run -d -p 3000:3000 --name nextjs-container --restart always nextjs-app

          echo "âœ… Deployment Successful!"
          docker ps
          '

          echo "âœ… Deployment is running in screen session: regXperienceScreen"

          EOF
