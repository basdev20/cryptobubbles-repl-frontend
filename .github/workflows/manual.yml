name: Deploy to AWS EC2
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Connect to EC2 and Run Deployment
        run: |
          echo "ğŸš€ Connecting to EC2..."
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.USERNAME }}@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
          
          echo "âœ… SSH Connection Established!"

          # Debugging: Check if screen exists
          if ! command -v screen &> /dev/null; then
              echo "âš ï¸ Screen is not installed. Installing now..."
              sudo apt update && sudo apt install -y screen
          else
              echo "âœ… Screen is installed."
          fi

          # Debugging: Check existing screen sessions
          echo "ğŸ–¥ï¸ Checking existing screen sessions..."
          screen -ls || echo "No active screen sessions."

          # Ensure Docker is installed
          if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              sudo apt update && sudo apt install -y docker.io
          fi

          # Stop the existing screen session if running
          if screen -ls | grep -q "production"; then
              echo "ğŸ›‘ Stopping existing screen session..."
              screen -S production -X quit
          fi

          # Debugging: Recheck screen sessions after killing
          echo "ğŸ–¥ï¸ Active screen sessions after stopping:"
          screen -ls || echo "No active screen sessions."

          # Start a new screen session
          echo "ğŸš€ Starting new screen session for deployment..."
          screen -L -Logfile ~/deploy.log -S production -dm bash -c 'echo "Hello world"'

 

